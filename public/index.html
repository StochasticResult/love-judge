<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Love Judge Chat</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-fg: #ffffff;
      --bg-app: #f3f4f6;
      --bg-panel: #ffffff;
      --border: #e5e7eb;
      --text-main: #1f2937;
      --text-sub: #6b7280;
      --bubble-me: #2563eb;
      --bubble-peer: #f3f4f6;
      --red: #ef4444;
      --green: #10b981;
    }
    
    * { box-sizing: border-box; }
    body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkVSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-app); color: var(--text-main); }
    
    /* ç™»å½•é¡µ */
    #auth-screen {
      display: flex; align-items: center; justify-content: center; height: 100%;
      background: linear-gradient(135deg, #e0e7ff, #f3e8ff);
    }
    .auth-card {
      background: var(--bg-panel); padding: 2rem; border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 400px;
    }
    .auth-card h1 { margin-top: 0; color: var(--primary); text-align: center; }
    
    /* ä¸»åº”ç”¨å¸ƒå±€ */
    #app-screen { display: none; height: 100%; width: 100%; overflow: hidden; }
    .sidebar {
      width: 320px; background: var(--bg-panel); border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
    }
    .main-chat {
      flex: 1; display: flex; flex-direction: column; background: #fff; position: relative;
    }
    
    /* ä¾§è¾¹æ å…ƒç´  */
    .my-profile {
      padding: 1rem; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center; background: #f9fafb;
    }
    .user-avatar {
      width: 40px; height: 40px; border-radius: 50%; background: #ddd; color: #666;
      display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;
    }
    .add-friend-box { padding: 0.5rem; border-bottom: 1px solid var(--border); display: flex; gap: 0.5rem; }
    .friend-list { flex: 1; overflow-y: auto; }
    .friend-item {
      padding: 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem;
      transition: background 0.2s;
    }
    .friend-item:hover, .friend-item.active { background: #f3f4f6; }
    .friend-info { flex: 1; min-width: 0; }
    .friend-name { font-weight: 600; font-size: 0.95rem; }
    .friend-last-msg { color: var(--text-sub); font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* èŠå¤©çª—å£ */
    .chat-header {
      padding: 0.75rem 1rem; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.9);
      backdrop-filter: blur(5px); z-index: 10;
    }
    .empty-state {
      flex: 1; display: flex; align-items: center; justify-content: center; color: var(--text-sub); flex-direction: column;
    }
    
    /* æ¡ˆä»¶é¢æ¿ï¼ˆåµŒå…¥èŠå¤©é¡¶éƒ¨ï¼‰ */
    .case-banner {
      background: #eff6ff; border-bottom: 1px solid #dbeafe; padding: 0.75rem 1rem;
      display: flex; align-items: center; justify-content: space-between; gap: 1rem;
      font-size: 0.9rem;
    }
    .case-info strong { color: #1e40af; display: block; }
    .case-status { font-size: 0.8rem; color: #60a5fa; }
    .case-actions { display: flex; gap: 0.5rem; }
    
    /* æ¶ˆæ¯åˆ—è¡¨ */
    .message-list {
      flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem;
      background: #f8fafc;
    }
    .msg { max-width: 70%; padding: 0.5rem 0.8rem; border-radius: 12px; font-size: 0.95rem; line-height: 1.4; position: relative; word-wrap: break-word; }
    .msg.mine { align-self: flex-end; background: var(--bubble-me); color: white; border-bottom-right-radius: 2px; }
    .msg.theirs { align-self: flex-start; background: var(--bubble-peer); color: var(--text-main); border-bottom-left-radius: 2px; }
    .msg-time { font-size: 0.65rem; opacity: 0.7; margin-top: 2px; text-align: right; }
    
    /* è¾“å…¥æ¡† */
    .chat-input-area {
      padding: 1rem; border-top: 1px solid var(--border); background: white;
      display: flex; gap: 0.5rem; align-items: flex-end;
    }
    textarea {
      flex: 1; border: 1px solid var(--border); border-radius: 20px; padding: 10px 14px;
      font-family: inherit; resize: none; height: 42px; max-height: 100px; outline: none;
    }
    textarea:focus { border-color: var(--primary); }
    
    /* é€šç”¨ç»„ä»¶ */
    input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; }
    button {
      padding: 8px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer;
      background: var(--primary); color: white; transition: 0.2s; white-space: nowrap;
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.secondary { background: #e5e7eb; color: var(--text-main); }
    button.danger { background: var(--red); color: white; }
    button.success { background: var(--green); color: white; }
    button.icon-btn { padding: 8px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
    
    /* æ¨¡æ€æ¡† */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4);
      display: flex; align-items: center; justify-content: center; z-index: 100;
    }
    .modal { background: white; width: 90%; max-width: 500px; border-radius: 12px; padding: 1.5rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    .hidden { display: none !important; }
    
    /* å“åº”å¼ï¼šç§»åŠ¨ç«¯éšè—ä¾§è¾¹æ  */
    @media (max-width: 640px) {
      .sidebar { width: 100%; position: absolute; height: 100%; z-index: 20; transform: translateX(0); transition: transform 0.3s; }
      .sidebar.closed { transform: translateX(-100%); }
      .main-chat { width: 100%; }
      .back-btn { display: block; margin-right: 8px; }
    }
    @media (min-width: 641px) {
      .back-btn { display: none; }
      #app-screen { display: flex; }
      .sidebar { position: relative; transform: none; }
    }
    
    /* åˆ¤å†³è¯¦æƒ…è¦†ç›–å±‚ */
    #hearing-screen {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: white; z-index: 50; display: flex; flex-direction: column;
      overflow-y: auto; padding: 2rem;
    }
    .hearing-container { max-width: 800px; margin: 0 auto; width: 100%; }
  </style>
</head>
<body>

  <div id="auth-screen">
    <div class="auth-card">
      <h1>âš–ï¸ Love Judge</h1>
      <p style="text-align:center; color:#6b7280; margin-bottom:1.5rem;">å…³ç³»çº çº·è§£å†³ä¸­å¿ƒ Â· èŠå¤©ç‰ˆ</p>
      <input id="email" placeholder="é‚®ç®±" />
      <input id="name" placeholder="æ˜µç§° (æ³¨å†Œæ—¶å¡«)" />
      <input id="pwd" type="password" placeholder="å¯†ç " />
      <div style="display:flex; gap:10px; margin-top:10px;">
        <button onclick="doAuth('login')" class="secondary" style="flex:1">ç™»å½•</button>
        <button onclick="doAuthZX('signup')" style="flex:1">æ³¨å†Œ</button>
      </div>
      <p id="auth-msg" style="color:var(--red); font-size:12px; text-align:center; margin-top:10px;"></p>
    </div>
  </div>

  <div id="app-screen">
    
    <div class="sidebar" id="sidebar">
      <div class="my-profile">
        <div style="display:flex; align-items:center; gap:10px;">
          <div class="user-avatar" id="my-avatar">Me</div>
          <div>
            <div style="font-weight:bold;" id="my-name">...</div>
            <div style="font-size:12px; color:green;">â— åœ¨çº¿</div>
          </div>
        </div>
        <button class="secondary" style="padding:4px 8px; font-size:12px;" onclick="logout()">é€€å‡º</button>
      </div>
      
      <div class="add-friend-box">
        <input id="friend-email-input" placeholder="è¾“å…¥å¥½å‹é‚®ç®±..." style="margin:0; font-size:13px;" />
        <button onclick="addFriend()" style="padding:0 12px;">+</button>
      </div>

      <div class="friend-list" id="friend-list">
        </div>
    </div>

    <div class="main-chat">
      <div class="chat-header hidden" id="chat-header">
        <div style="display:flex; align-items:center;">
          <button class="back-btn secondary" onclick="toggleSidebar()">â†</button>
          <div class="user-avatar" id="current-peer-avatar" style="margin-right:10px; width:32px; height:32px; font-size:12px;">?</div>
          <strong id="current-peer-name">è”ç³»äºº</strong>
        </div>
        <button class="secondary" onclick="openCreateCaseModal()" style="font-size:13px;">âš–ï¸ å‘èµ·å®¡åˆ¤</button>
      </div>

      <div id="active-case-banner" class="case-banner hidden">
        <div class="case-info">
          <strong id="banner-topic">å‘¨æœ«å»å“ªå„¿ï¼Ÿ</strong>
          <span id="banner-status" class="case-status">ç­‰å¾…å¯¹æ–¹æ¥å— â€¢ 23å°æ—¶åè¿‡æœŸ</span>
        </div>
        <div class="case-actions" id="banner-actions">
          </div>
      </div>

      <div class="message-list" id="message-list">
        <div class="empty-state">
          <div style="font-size:3rem; margin-bottom:1rem;">ğŸ‘‹</div>
          <p>é€‰æ‹©ä¸€ä¸ªå¥½å‹å¼€å§‹èŠå¤©</p>
          <p style="font-size:0.9rem;">é‡åˆ°åˆ†æ­§ï¼Ÿç‚¹å‡»å³ä¸Šè§’â€œå‘èµ·å®¡åˆ¤â€</p>
        </div>
      </div>

      <div class="chat-input-area hidden" id="chat-input-area">
        <textarea id="msg-input" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
        <button onclick="sendMessage()">å‘é€</button>
      </div>
    </div>

    <div id="hearing-screen" class="hidden">
      <div class="hearing-container">
        <button class="secondary" onclick="closeHearing()" style="margin-bottom:1rem;">â† è¿”å›èŠå¤©</button>
        <div class="auth-card" style="max-width:100%; padding:0; box-shadow:none; background:transparent;">
          <h2 id="hearing-topic" style="margin-top:0;">æ¡ˆä»¶æ ‡é¢˜</h2>
          <p id="hearing-status" style="color:var(--text-sub); margin-bottom:1rem;">çŠ¶æ€</p>
          
          <div id="hearing-content">
            <div id="statement-form" class="hidden">
              <div style="background:#fff; padding:1.5rem; border-radius:12px; border:1px solid var(--border);">
                <h3>æäº¤ä½ çš„é™ˆè¿° (Round <span id="round-num">1</span>)</h3>
                <p style="font-size:13px; color:#666;">AI æ³•å®˜ä¼šåŸºäºä½ çš„æè¿°è¿›è¡Œå…¬æ­£åˆ¤å†³ã€‚</p>
                <textarea id="my-statement" style="height:120px; margin-top:10px;" placeholder="å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿä½ çš„æ„Ÿå—æ˜¯ï¼Ÿ"></textarea>
                <button onclick="submitStatement()" style="width:100%; margin-top:10px;">æäº¤é™ˆè¿°</button>
              </div>
            </div>

            <div id="waiting-verdict" class="hidden" style="text-align:center; padding:2rem;">
              <h3>ç­‰å¾…åˆ¤å†³...</h3>
              <p>åŒæ–¹éƒ½æäº¤åï¼Œæ‚¨å¯ä»¥ç‚¹å‡»â€œè¯·æ±‚åˆ¤å†³â€ã€‚</p>
              <button id="trigger-judge-btn" onclick="triggerJudge()" class="hidden">ç°åœ¨è¯·æ±‚ AI åˆ¤å†³</button>
            </div>

            <div id="verdict-display" class="hidden">
              <div style="background:#fff; padding:1.5rem; border-radius:12px; border:1px solid var(--border); box-shadow:0 4px 12px rgba(0,0,0,0.05);">
                <h3 style="text-align:center; color:var(--primary);">âš–ï¸ åˆ¤å†³ç»“æœ</h3>
                
                <div style="display:flex; height:20px; border-radius:10px; overflow:hidden; margin:1rem 0;">
                  <div id="bar-a" style="background:#3b82f6; width:50%;"></div>
                  <div id="bar-b" style="background:#ec4899; width:50%;"></div>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:bold; margin-bottom:1.5rem;">
                  <span style="color:#3b82f6;">æˆ‘æ–¹æ”¯æŒç‡ <span id="score-a">0%</span></span>
                  <span style="color:#ec4899;">å¯¹æ–¹æ”¯æŒç‡ <span id="score-b">0%</span></span>
                </div>

                <div style="margin-bottom:1rem;">
                  <strong>ç»“è®ºï¼š</strong>
                  <p id="v-summary" style="margin:4px 0; color:#333;"></p>
                </div>
                <div style="margin-bottom:1rem;">
                  <strong>äº‹å®ä¾æ®ï¼š</strong>
                  <p id="v-facts" style="font-size:0.9rem; color:#555;"></p>
                </div>
                <div style="margin-bottom:1rem;">
                  <strong>å»ºè®®ï¼š</strong>
                  <ul id="v-advice" style="font-size:0.9rem; color:#555; padding-left:1.2rem;"></ul>
                </div>
                
                <button class="secondary" style="width:100%; margin-top:1rem;" onclick="openAppeal()">ä¸æœï¼Ÿå‘èµ·ä¸Šè¯‰</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="create-case-modal" class="modal-overlay hidden">
    <div class="modal">
      <h3>âš–ï¸ å‘èµ·æ–°æ¡ˆä»¶</h3>
      <p style="color:#666; font-size:13px; margin-bottom:1rem;">é‚€è¯·å¯¹æ–¹è¿›å…¥â€œLove Judgeâ€æµç¨‹ã€‚å¯¹æ–¹æœ‰ 24 å°æ—¶æ¥å—æ—¶é—´ã€‚</p>
      <input id="new-case-topic" placeholder="äº‰è®ºçš„ä¸»é¢˜ (ä¾‹å¦‚ï¼šä»Šæ™šè°æ´—ç¢—)" />
      <div style="display:flex; gap:10px;">
        <button class="secondary" onclick="$('create-case-modal').classList.add('hidden')" style="flex:1">å–æ¶ˆ</button>
        <button onclick="createCase()" style="flex:1">å‘é€é‚€è¯·</button>
      </div>
    </div>
  </div>

  <script>
    // --- æ ¸å¿ƒçŠ¶æ€ä¸å·¥å…· ---
    const API_URL = "";
    const state = {
      token: localStorage.getItem("lj_token"),
      user: null,
      activePeer: null, // å½“å‰èŠå¤©çš„æœ‹å‹å¯¹è±¡
      messages: [],
      activeCase: null, // å½“å‰èŠå¤©ä¸Šä¸‹æ–‡ä¸­çš„æ´»è·ƒæ¡ˆä»¶
      pollInterval: null
    };
    
    const $ = (id) => document.getElementById(id);

    async function api(path, method="GET", body=null) {
      const headers = { "Content-Type": "application/json" };
      if (state.token) headers["Authorization"] = `Bearer ${state.token}`;
      const opts = { method, headers };
      if (body) opts.body = JSON.stringify(body);
      const res = await fetch(API_URL + path, opts);
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    // --- è®¤è¯æµç¨‹ ---
    async function init() {
      if (state.token) {
        try {
          const { user } = await api("/me");
          state.user = user;
          showApp();
        } catch (e) {
          logout();
        }
      }
    }

    async function doAuth(type) {
      const email = $("email").value;
      const pwd = $("pwd").value;
      const name = $("name").value;
      try {
        const path = type === "login" ? "/auth/login" : "/auth/signup";
        const body = { email, password: pwd };
        if (type === "signup") body.name = name;

        const res = await api(path, "POST", body);
        state.token = res.token;
        localStorage.setItem("lj_token", res.token);
        state.user = res.user;
        $("auth-msg").textContent = "";
        showApp();
      } catch (e) {
        let msg = e.message;
        try {
          const parsed = JSON.parse(e.message);
          msg = parsed.error || msg;
        } catch (_) {}
        $("auth-msg").textContent = "è®¤è¯å¤±è´¥: " + msg;
      }
    }
    // hack for rename conflict
    const doAuthZX = doAuth; 

    function logout() {
      localStorage.removeItem("lj_token");
      location.reload();
    }

    function showApp() {
      $("auth-screen").style.display = "none";
      $("app-screen").style.display = "flex";
      $("my-name").textContent = state.user.name;
      $("my-avatar").textContent = state.user.name[0].toUpperCase();
      loadFriends();
      startPolling();
    }

    // --- ä¾§è¾¹æ ä¸å¥½å‹ ---
    async function loadFriends() {
      try {
        // è·å–å¥½å‹åˆ—è¡¨å’Œæœ€è¿‘å¯¹è¯
        const [friendsRes, convRes] = await Promise.all([
          api("/friends"),
          api("/conversations")
        ]);
        
        const list = $("friend-list");
        list.innerHTML = "";
        
        // åˆå¹¶å±•ç¤ºï¼Œä¼˜å…ˆå±•ç¤ºæœ‰å¯¹è¯çš„
        const friendsMap = new Map();
        friendsRes.friends.forEach(f => friendsMap.set(f.id, { ...f, lastMsg: "" }));
        
        // æ›´æ–°æœ€è¿‘æ¶ˆæ¯
        convRes.conversations.forEach(c => {
          if (friendsMap.has(c.peer.id)) {
            friendsMap.get(c.peer.id).lastMsg = c.last_message?.content || "";
          } else {
            // å¦‚æœä¸åœ¨å¥½å‹åˆ—è¡¨ä½†åœ¨å¯¹è¯åˆ—è¡¨ï¼ˆæå°‘æƒ…å†µï¼‰ï¼Œä¹ŸåŠ ä¸Š
            friendsMap.set(c.peer.id, { ...c.peer, lastMsg: c.last_message?.content || "" });
          }
        });

        friendsMap.forEach(friend => {
          const item = document.createElement("div");
          item.className = "friend-item";
          if (state.activePeer && state.activePeer.id === friend.id) item.classList.add("active");
          item.onclick = () => selectPeer(friend);
          item.innerHTML = `
            <div class="user-avatar">${friend.name[0].toUpperCase()}</div>
            <div class="friend-info">
              <div class="friend-name">${friend.name}</div>
              <div class="friend-last-msg">${friend.lastMsg || "æš‚æ— æ¶ˆæ¯"}</div>
            </div>
          `;
          list.appendChild(item);
        });

      } catch (e) { console.error(e); }
    }

    async function addFriend() {
      const email = $("friend-email-input").value.trim();
      if (!email) return;
      try {
        await api(`/friends/${encodeURIComponent(email)}`, "POST");
        $("friend-email-input").value = "";
        loadFriends();
      } catch (e) { alert("æ·»åŠ å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±"); }
    }

    // --- èŠå¤©åŠŸèƒ½ ---
    function toggleSidebar() {
      $("sidebar").classList.toggle("closed");
    }

    async function selectPeer(peer) {
      state.activePeer = peer;
      $("sidebar").classList.add("closed"); // ç§»åŠ¨ç«¯è‡ªåŠ¨æ”¶èµ·
      
      // UI æ›´æ–°
      $("chat-header").classList.remove("hidden");
      $("chat-input-area").classList.remove("hidden");
      $("current-peer-name").textContent = peer.name;
      $("current-peer-avatar").textContent = peer.name[0].toUpperCase();
      
      // é«˜äº®ä¾§è¾¹æ 
      Array.from(document.querySelectorAll(".friend-item")).forEach(el => el.classList.remove("active"));
      // ç®€å•é‡æ–°æ¸²æŸ“å¥½å‹åˆ—è¡¨æ¥æ›´æ–°é«˜äº®ç•¥æ˜¾ç¬¨é‡ï¼Œè¿™é‡Œçœç•¥ä¼˜åŒ–
      
      loadMessages();
      loadActiveCase();
    }

    async function loadMessages() {
      if (!state.activePeer) return;
      const res = await api(`/chat/${state.activePeer.id}`);
      state.messages = res.messages;
      renderMessages();
    }

    function renderMessages() {
      const container = $("message-list");
      container.innerHTML = "";
      state.messages.forEach(m => {
        const div = document.createElement("div");
        const isMe = m.from_user_id === state.user.id;
        div.className = `msg ${isMe ? "mine" : "theirs"}`;
        div.innerHTML = `
          ${m.content}
          <div class="msg-time">${new Date(m.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        `;
        container.appendChild(div);
      });
      container.scrollTop = container.scrollHeight;
    }

    async function sendMessage() {
      const txt = $("msg-input").value.trim();
      if (!txt || !state.activePeer) return;
      $("msg-input").value = "";
      
      // ä¹è§‚æ›´æ–° UI
      const mockMsg = {
        id: "temp-" + Date.now(),
        from_user_id: state.user.id,
        content: txt,
        created_at: new Date().toISOString()
      };
      state.messages.push(mockMsg);
      renderMessages();

      await api(`/chat/${state.activePeer.id}`, "POST", { content: txt });
      loadMessages(); // é‡æ–°æ‹‰å–ä»¥ç¡®è®¤
      loadFriends(); // æ›´æ–°ä¾§è¾¹æ æœ€åæ¶ˆæ¯
    }

    // --- æ¡ˆä»¶é›†æˆé€»è¾‘ ---
    
    // å¯»æ‰¾å½“å‰èŠå¤©å¯¹è±¡ç›¸å…³çš„æ´»è·ƒæ¡ˆä»¶
    async function loadActiveCase() {
      if (!state.activePeer) return;
      const { cases } = await api("/cases");
      
      // è¿‡æ»¤è§„åˆ™ï¼š
      // 1. æˆ‘æ˜¯ participant (åç«¯å·²è¿‡æ»¤)
      // 2. æ¡ˆä»¶æœªå…³é—­ (status != closed, expired)
      // 3. æ¡ˆä»¶çš„å¦ä¸€ä¸ª participant æ˜¯ activePeer
      // æ³¨æ„ï¼šcases åˆ—è¡¨ä¸ç›´æ¥ç»™ participants è¯¦æƒ…ï¼Œåªç»™ idï¼Œä½†åç«¯ listCasesByUser é€»è¾‘ä¼¼ä¹åªè¿”å›æ¦‚è¦
      // æˆ‘ä»¬éœ€è¦éå†æŸ¥æ‰¾ã€‚
      
      // è¿™é‡Œæœ‰ä¸ªåç«¯æ•°æ®ç»“æ„çš„å°é—®é¢˜ï¼š/cases åˆ—è¡¨è¿”å›çš„ case å¯¹è±¡é‡Œæ²¡æœ‰ explicit çš„ participant list stringï¼Œ
      // ä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡ logic æ¨æ–­ã€‚æˆ–è€…è·å– case è¯¦æƒ…ã€‚
      // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å‡è®¾æ¯ä¸ª active case æˆ‘ä»¬éƒ½å» fetch è¯¦æƒ…çœ‹ä¸€çœ¼ participant æ˜¯å¦åŒ¹é…ã€‚
      // ä¼˜åŒ–ï¼šåªå–æœ€è¿‘ä¸€ä¸ªæœªå…³é—­çš„ caseã€‚
      
      const active = [];
      for (let c of cases) {
        if (["closed", "expired"].includes(c.status)) continue;
        // è·å–è¯¦æƒ…ä»¥ç¡®è®¤å‚ä¸è€…
        try {
           const detail = await api(`/cases/${c.id}`);
           const pIds = detail.case.participant_ids || [];
           if (pIds.includes(state.activePeer.id)) {
             active.push(detail.case);
           }
        } catch(e) {}
      }
      
      // å–æœ€æ–°çš„ä¸€ä¸ª
      active.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
      const currentCase = active[0];
      
      state.activeCase = currentCase;
      renderCaseBanner(currentCase);
    }

    function renderCaseBanner(c) {
      const banner = $("active-case-banner");
      const actions = $("banner-actions");
      actions.innerHTML = "";
      
      if (!c) {
        banner.classList.add("hidden");
        return;
      }
      
      banner.classList.remove("hidden");
      $("banner-topic").textContent = "âš–ï¸ æ¡ˆä»¶ï¼š" + c.topic;
      
      // çŠ¶æ€é€»è¾‘
      const isOwner = c.owner_id === state.user.id;
      let statusText = "";
      
      if (c.status === "pending_acceptance") {
        if (c.acceptance === "pending") {
          // æ£€æŸ¥æˆ‘æ˜¯å¦æ˜¯è¢«é‚€è¯·è€…
          if (c.invited_user_id === state.user.id) {
            statusText = "å¯¹æ–¹é‚€è¯·ä½ å‚ä¸å®¡åˆ¤";
            actions.innerHTML = `
              <button onclick="respondCase('${c.id}', 'accept')" class="success" style="padding:4px 10px; font-size:12px;">æ¥å—</button>
              <button onclick="respondCase('${c.id}', 'reject')" class="danger" style="padding:4px 10px; font-size:12px;">æ‹’ç»</button>
            `;
          } else {
            statusText = "ç­‰å¾…å¯¹æ–¹æ¥å—é‚€è¯·";
            actions.innerHTML = `<span style="font-size:12px; color:#999;">ç­‰å¾…ä¸­...</span>`;
          }
          // è¿‡æœŸå€’è®¡æ—¶é€»è¾‘ç•¥ï¼Œä»…æ˜¾ç¤ºæç¤º
          if (c.expires_at) {
            const hoursLeft = Math.floor((new Date(c.expires_at) - new Date()) / 3600000);
            if (hoursLeft > 0) statusText += ` (${hoursLeft}å°æ—¶åè¿‡æœŸ)`;
            else statusText = "å·²è¿‡æœŸ";
          }
        }
      } else if (c.status === "draft" || c.status === "pending_judgement" || c.status === "decided" || c.status === "appealed") {
        statusText = "æ¡ˆä»¶è¿›è¡Œä¸­";
        actions.innerHTML = `<button onclick="enterCase('${c.id}')" style="padding:4px 10px; font-size:12px;">è¿›å…¥æ³•åº­</button>`;
      }
      
      $("banner-status").textContent = statusText;
    }

    function openCreateCaseModal() {
      if (!state.activePeer) return alert("è¯·å…ˆé€‰æ‹©èŠå¤©å¯¹è±¡");
      $("create-case-modal").classList.remove("hidden");
    }

    async function createCase() {
      const topic = $("new-case-topic").value.trim();
      if (!topic) return;
      try {
        await api("/cases", "POST", { 
          topic, 
          friend_email: state.activePeer.email 
        });
        $("create-case-modal").classList.add("hidden");
        $("new-case-topic").value = "";
        // å‘é€ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯ï¼ˆå¯é€‰ï¼Œå‰ç«¯ä¼ªé€ æˆ–çœŸå®å‘é€ï¼‰
        await api(`/chat/${state.activePeer.id}`, "POST", { content: `[ç³»ç»Ÿ] æˆ‘å‘èµ·äº†ä¸€ä¸ªæ¡ˆä»¶é‚€è¯·ï¼š${topic}` });
        loadMessages();
        loadActiveCase();
      } catch (e) { alert(e.message); }
    }

    async function respondCase(id, action) {
      try {
        await api(`/cases/${id}/${action}`, "POST");
        loadActiveCase();
      } catch (e) { alert(e.message); }
    }

    // --- å®¡ç†/åˆ¤å†³ è¯¦æƒ…é¡µ ---
    async function enterCase(caseId) {
      const res = await api(`/cases/${caseId}`);
      const c = res.case;
      const hearing = res.latest_hearing;
      const verdict = res.latest_verdict;
      state.activeCase = c;
      
      $("hearing-screen").classList.remove("hidden");
      $("hearing-topic").textContent = c.topic;
      $("hearing-status").textContent = `Case ID: ${c.id.slice(0,8)} Â· Round ${hearing ? hearing.round : 1}`;
      
      // é€»è¾‘è·¯ç”±
      $("statement-form").classList.add("hidden");
      $("waiting-verdict").classList.add("hidden");
      $("verdict-display").classList.add("hidden");
      $("trigger-judge-btn").classList.add("hidden");
      
      if (!hearing) {
        // Round 1 åˆšå¼€å§‹
        $("statement-form").classList.remove("hidden");
        $("round-num").textContent = "1";
      } else if (hearing.status === "submitted") {
        $("waiting-verdict").classList.remove("hidden");
        $("statement-form").classList.remove("hidden");
        $("waiting-verdict").classList.remove("hidden");
        $("trigger-judge-btn").classList.remove("hidden");
      } else if (hearing.status === "judged" && verdict) {
        renderVerdict(verdict);
      }
      
      // æš‚å­˜ ID ä»¥ä¾¿æ“ä½œ
      state.currentCaseId = caseId;
      state.currentHearingId = hearing ? hearing.id : null;
    }
    
    // ç”±äºåç«¯æ²¡æœ‰å•ç‹¬åˆ—å‡º statements çš„æ¥å£ï¼Œæˆ‘ä»¬åªèƒ½ä¾èµ– POST hearings æ—¶çš„é€»è¾‘
    // è¿™é‡Œå¦‚æœ hearing å·²ç»å­˜åœ¨ï¼Œæˆ‘ä»¬è¿˜æ˜¯è°ƒç”¨ POST hearingsï¼Œåç«¯ä¼šåˆ›å»ºæ–°çš„ hearing å—ï¼Ÿ
    // çœ‹åç«¯ä»£ç ï¼šPOST /hearings ä¼š calculate nextRoundã€‚
    // å¦‚æœæˆ‘ä»¬è¦è¿½åŠ é™ˆè¿°åˆ°å½“å‰ hearingï¼Œä¼¼ä¹åç«¯æ²¡æœ‰æ˜¾å¼æ”¯æŒ update statementï¼Ÿ
    // åç«¯ saveStatements æ˜¯ appendã€‚
    // æ‰€ä»¥é€»è¾‘æ˜¯ï¼šå¦‚æœ hearing å­˜åœ¨ä¸” submittedï¼Œå†æ¬¡ POST hearings ä¼šåˆ›å»º *ä¸‹ä¸€ä¸ª round* å—ï¼Ÿ
    // ä¸ï¼Œåç«¯é€»è¾‘æ˜¯ï¼šnextRound = param ?? max + 1. 
    // æ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³å¾€å½“å‰ round åŠ æ•°æ®ï¼Œæ¯”è¾ƒéš¾ã€‚
    // ä¿®æ­£ç­–ç•¥ï¼šå¦‚æœ hearing å­˜åœ¨ä¸”æœª judgedï¼Œç”¨æˆ·åº”å½“åªèƒ½ç‚¹å‡»â€œè¯·æ±‚åˆ¤å†³â€ã€‚
    // ä½†å¦‚æœç”¨æˆ·è¿˜æ²¡é™ˆè¿°å‘¢ï¼Ÿè¿™æ˜¯ä¸€ä¸ªåç«¯è®¾è®¡çš„å°ç¼ºæ†¾ã€‚
    // å‡è®¾ï¼šç”¨æˆ·æ¯æ¬¡ enter éƒ½å¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡é™ˆè¿°ã€‚
    // ä¸´æ—¶æ–¹æ¡ˆï¼šå§‹ç»ˆæ˜¾ç¤ºæäº¤æ¡†ï¼Œæäº¤æ—¶å¸¦ä¸Š round = currentRound (å¦‚æœèƒ½ä¼ )ã€‚
    // åç«¯ä»£ç ï¼š const nextRound = parsed.data.round ?? ...
    // æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¼  roundã€‚
    
    async function submitStatement() {
      const narrative = $("my-statement").value;
      if (!narrative) return;
      
      // ç¡®å®šæ˜¯ A è¿˜æ˜¯ B
      // case.parties æ•°ç»„ï¼Œ owner æ˜¯ parties[0] (A) ? ä¸ä¸€å®šï¼Œçœ‹åˆ›å»ºé€»è¾‘ã€‚
      // åç«¯ createCase é»˜è®¤ owner=participant_ids[0]ï¼Œparties[0]=A
      // ç®€åŒ–ï¼šæˆ‘ä»¬éœ€è¦çŸ¥é“æˆ‘æ˜¯ A è¿˜æ˜¯ Bã€‚
      // æš‚æ—¶å‡è®¾ owner = A.
      const isOwner = state.activeCase && state.activeCase.owner_id === state.user.id;
      const side = isOwner ? "A" : "B";
      
      const body = {
        statements: [{ side, narrative }],
      };
      
      // å¦‚æœå·²çŸ¥ hearingIdï¼Œè¯•å›¾å¤ç”¨ round
      // ä½†ä¸ºäº†å®‰å…¨ï¼Œç›´æ¥è®©åç«¯å¤„ç†ï¼Œæˆ‘ä»¬åªç®¡æäº¤
      // æ³¨æ„ï¼šå¦‚æœ hearing å·²ç»å­˜åœ¨ï¼Œä¸ä¼  round ä¼šå¯¼è‡´åˆ›å»º round+1ã€‚
      // æˆ‘ä»¬å¿…é¡»è·å–å½“å‰ roundã€‚
      // åœ¨ enterCase é‡Œæˆ‘ä»¬è·å–äº† latest_hearingã€‚
      
      const res = await api(`/cases/${state.currentCaseId}`);
      const latest = res.latest_hearing;
      
      if (latest && latest.status === 'submitted') {
         body.round = latest.round;
      }
      
      try {
        const hRes = await api(`/cases/${state.currentCaseId}/hearings`, "POST", body);
        state.currentHearingId = hRes.hearing.id;
        $("my-statement").value = "";
        alert("é™ˆè¿°å·²æäº¤");
        enterCase(state.currentCaseId); // åˆ·æ–°è§†å›¾
      } catch (e) { alert(e.message); }
    }

    async function triggerJudge() {
      if (!state.currentHearingId) return alert("è¯·å…ˆæäº¤é™ˆè¿°");
      try {
        const res = await api(`/cases/${state.currentCaseId}/hearings/${state.currentHearingId}/judge`, "POST");
        enterCase(state.currentCaseId);
      } catch(e) { alert("åˆ¤å†³å¤±è´¥ (å¯èƒ½å¯¹æ–¹è¿˜æ²¡æäº¤?): " + e.message); }
    }
    
    function renderVerdict(v) {
      $("verdict-display").classList.remove("hidden");
      $("score-a").textContent = v.score.partyA_pct + "%";
      $("score-b").textContent = v.score.partyB_pct + "%";
      $("bar-a").style.width = v.score.partyA_pct + "%";
      $("bar-b").style.width = v.score.partyB_pct + "%";
      
      $("v-summary").textContent = v.summary;
      $("v-facts").textContent = v.reasoning.facts;
      
      const adviceHtml = [];
      [...v.advice.together, ...v.advice.forA, ...v.advice.forB].forEach(txt => {
        adviceHtml.push(`<li>${txt}</li>`);
      });
      $("v-advice").innerHTML = adviceHtml.join("");
    }
    
    async function openAppeal() {
       // ä¸Šè¯‰é€»è¾‘ï¼šç›´æ¥åˆ›å»ºæ–°ä¸€è½® hearing
       // ç®€å•å®ç°ï¼šæ¸…ç©ºè¾“å…¥æ¡†ï¼Œå›åˆ°æäº¤çŠ¶æ€ï¼Œå¹¶ä¸” round ä¼šè‡ªåŠ¨ +1
       alert("ä¸Šè¯‰æ¨¡å¼ï¼šè¯·åœ¨ä¸Šæ–¹è¾“å…¥æ¡†å¡«å†™æ–°çš„è¡¥å……é™ˆè¿°ï¼Œå†æ¬¡æäº¤å³å¯å¼€å¯ä¸‹ä¸€è½®ã€‚");
       $("statement-form").classList.remove("hidden");
       $("waiting-verdict").classList.add("hidden");
       $("verdict-display").classList.add("hidden");
       $("my-statement").focus();
       // æ­¤æ—¶ currentHearingId æŒ‡å‘æ—§çš„ï¼Œæäº¤æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„ï¼ˆå› ä¸ºä¸ä¼  roundï¼‰
    }

    function closeHearing() {
      $("hearing-screen").classList.add("hidden");
      loadActiveCase(); // åˆ·æ–° Banner çŠ¶æ€
    }

    // --- è½®è¯¢ ---
    function startPolling() {
      if (state.pollInterval) clearInterval(state.pollInterval);
      state.pollInterval = setInterval(() => {
        if (!state.token) return;
        // ç®€å•è½®è¯¢æ¶ˆæ¯å’Œæ¡ˆä»¶çŠ¶æ€
        if (state.activePeer) {
           loadMessages();
           loadActiveCase(); // å®æ—¶æ›´æ–°æ¡ˆä»¶çŠ¶æ€ï¼ˆå¦‚å¯¹æ–¹æ¥å—äº†ï¼‰
        }
        // ä¹Ÿå¯ä»¥è½®è¯¢å¥½å‹åˆ—è¡¨çš„å°çº¢ç‚¹ï¼Œè¿™é‡Œç•¥
      }, 3000);
    }

    init();
  </script>
</body>
</html>
